import cv2
import time
import os

# Chemins logiques définis via udev
logical_cameras = [
    "/dev/camera_gauche",
    "/dev/camera_droite",
    "/dev/camera_haut"
]

# Conversion en chemins réels
cameras = [os.path.realpath(cam) for cam in logical_cameras]

# Paramètres vidéo
width, height = 640, 480
fps = 30
fourcc = cv2.VideoWriter_fourcc(*'XVID')

# Dossier de sortie
output_dir = "recordings"
os.makedirs(output_dir, exist_ok=True)

# Timestamp
timestamp = time.strftime("%Y-%m-%d_%H-%M-%S")

caps = []
outs = []

# Préparation des caméras
for i, cam_path in enumerate(cameras):
    cap = cv2.VideoCapture(cam_path, cv2.CAP_V4L2)
    cap.set(cv2.CAP_PROP_FRAME_WIDTH, width)
    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, height)
    cap.set(cv2.CAP_PROP_FPS, fps)

    if not cap.isOpened():
        print(f"❌ Impossible d’ouvrir {cam_path}")
        continue

    filename = os.path.join(output_dir, f"camera_{i}_{timestamp}.avi")
    out = cv2.VideoWriter(filename, fourcc, fps, (width, height))
    print(f"✅ Enregistrement de {logical_cameras[i]} ({cam_path}) → {filename}")

    caps.append(cap)
    outs.append(out)

if not caps:
    print("⚠️ Aucune caméra n’a pu être ouverte.")
    exit()

print("🎥 Enregistrement en cours pour 5 minutes...")

# Durée d’enregistrement en secondes
duration_sec = 20 * 60
start_time = time.time()

try:
    while True:
        current_time = time.time()
        elapsed = current_time - start_time
        if elapsed >= duration_sec:
            print("⏰ Durée écoulée : arrêt automatique.")
            break

        for i, cap in enumerate(caps):
            ret, frame = cap.read()
            if ret:
                outs[i].write(frame)
                cv2.imshow(f"Cam {i}", frame)

        if cv2.waitKey(1) & 0xFF == ord('q'):
            print("🛑 Enregistrement stoppé par l'utilisateur.")
            break

except KeyboardInterrupt:
    print("🛑 Interruption clavier.")

finally:
    for cap in caps:
        cap.release()
    for out in outs:
        out.release()
    cv2.destroyAllWindows()
    print("✅ Fichiers enregistrés dans le dossier 'recordings/'")
