import cv2
import time
import os

# Chemins logiques dÃ©finis via udev
logical_cameras = [
    "/dev/camera_gauche",
    "/dev/camera_droite",
    "/dev/camera_haut"
]

# Conversion en chemins rÃ©els
cameras = [os.path.realpath(cam) for cam in logical_cameras]

# ParamÃ¨tres vidÃ©o
width, height = 640, 480
fps = 30
fourcc = cv2.VideoWriter_fourcc(*'XVID')

# Dossier de sortie
output_dir = "recordings"
os.makedirs(output_dir, exist_ok=True)

# Timestamp
timestamp = time.strftime("%Y-%m-%d_%H-%M-%S")

caps = []
outs = []

# PrÃ©paration des camÃ©ras
for i, cam_path in enumerate(cameras):
    cap = cv2.VideoCapture(cam_path, cv2.CAP_V4L2)
    cap.set(cv2.CAP_PROP_FRAME_WIDTH, width)
    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, height)
    cap.set(cv2.CAP_PROP_FPS, fps)

    if not cap.isOpened():
        print(f"âŒ Impossible dâ€™ouvrir {cam_path}")
        continue

    filename = os.path.join(output_dir, f"camera_{i}_{timestamp}.avi")
    out = cv2.VideoWriter(filename, fourcc, fps, (width, height))
    print(f"âœ… Enregistrement de {logical_cameras[i]} ({cam_path}) â†’ {filename}")

    caps.append(cap)
    outs.append(out)

if not caps:
    print("âš ï¸ Aucune camÃ©ra nâ€™a pu Ãªtre ouverte.")
    exit()

print("ğŸ¥ Enregistrement en cours pour 5 minutes...")

# DurÃ©e dâ€™enregistrement en secondes
duration_sec = 20 * 60
start_time = time.time()

try:
    while True:
        current_time = time.time()
        elapsed = current_time - start_time
        if elapsed >= duration_sec:
            print("â° DurÃ©e Ã©coulÃ©e : arrÃªt automatique.")
            break

        for i, cap in enumerate(caps):
            ret, frame = cap.read()
            if ret:
                outs[i].write(frame)
                cv2.imshow(f"Cam {i}", frame)

        if cv2.waitKey(1) & 0xFF == ord('q'):
            print("ğŸ›‘ Enregistrement stoppÃ© par l'utilisateur.")
            break

except KeyboardInterrupt:
    print("ğŸ›‘ Interruption clavier.")

finally:
    for cap in caps:
        cap.release()
    for out in outs:
        out.release()
    cv2.destroyAllWindows()
    print("âœ… Fichiers enregistrÃ©s dans le dossier 'recordings/'")
